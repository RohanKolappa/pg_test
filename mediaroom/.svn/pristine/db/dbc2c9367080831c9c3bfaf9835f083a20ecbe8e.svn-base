let $groupNID:='_GROUPNID_'
let $dirNID := '_DIRNID_'  
let $queueID := '_QUEUEID_'      

let $dstTitle := '_DSTTITLE_'
let $uuid := '_UUID_'

let $destinationDoc := for $portDoc in  collection('ipvs.default.mediastreamdstportresourcelist')/*[.//Info/Title = $dstTitle] | 
    									collection('ipvs.default.mediastreamioportresourcelist')/* [.//Info/Title = $dstTitle]
    					return $portDoc
             
let $dirDoc :=    doc(concat('/db/ipvs.default.', 
          						substring-before( substring-after( $dirNID, 'default.') , '.'  ) , '/',
          						substring-after( substring-after( $dirNID, 'default.'),'.')))/*[@NID=$dirNID]
let $priorityPort := data($dirDoc/min(.//MediaStorePortResourceNIDList/MediaStorePortResourceNID[@priority!='']/@priority))   

let $portNID :=  data($dirDoc//MediaStorePortResourceNID[1][@priority = $priorityPort]) 

let $dirId := data($dirDoc//MediaStorePortResourceNID[@priority = $priorityPort and .= $portNID]/@deviceElementId)              
                      
let $portDoc :=    doc(concat('/db/ipvs.default.', 
          						substring-before( substring-after( $portNID, 'default.') , '.'  ) , '/',
          						substring-after( substring-after( $portNID, 'default.'),'.')))/*[@NID=$portNID]

let $deviceDoc := for $device in collection('/db/ipvs.default.devicelist')/*
						   						[.//MediaStorePortResourceNID/NIDValue = $portNID] 
												return $device
let $assetResourceNID :=    $portDoc//AssetResourceNID                     
let $assetResourceDoc :=      doc(concat('/db/ipvs.default.', 
          						substring-before( substring-after( $assetResourceNID, 'default.') , '.'  ) , '/',
          						substring-after( substring-after( $assetResourceNID, 'default.'),'.')))/*[@NID=$assetResourceNID]
 
let $dmsIP := data($deviceDoc//EthernetPortStatus/Parameters[Parameter[@name = 'Primary' and . = 'True'] and Parameter[@name = 'Status' and . = 'True']]/./Parameter[@name='IPAddress'])
let $apiKeyTable := $assetResourceDoc//ApiKeyTable
				                     
let $importURL := if($dmsIP !='') then 
                        concat("https://_IPADDRESS_","/mediajs/file/upload?mediaID=",$queueID,"&amp;uuid=", $uuid, "&amp;dirID=",$dirId, "&amp;groupnid=",$groupNID,"&amp;timestamp=_TIME_STAMP_CONST", "&amp;apiKey=", data($apiKeyTable/ApiKey/@key), "&amp;signature=_SIGNATURE_CONST")
                    else ''	
return <Import url='{$importURL}'>{$apiKeyTable} <Destination>{$destinationDoc}</Destination> <Source>{$portDoc}</Source>  <Device ipAddress='{$dmsIP}'> {$deviceDoc//DNSClientConfig}{$deviceDoc//NATZoneTableConfig}  {$deviceDoc//EthernetPortTableStatus} </Device> </Import>