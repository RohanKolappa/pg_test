
(: ------------------- Begin GetDestinationLib.xml -------------------- :)


(:Create the request document for GetDir :)


declare function local:getUri($NID as xs:string)
as xs:string
{
	let $uri1 := replace($NID, '\.', '/')
  	let $context := replace($uri1, "default/", "/db/ipvs.default.")
	return $context
};

declare function
local:createRequestDoc()as element()* {
	let $userJID := '_USERJID_'
	let $srcNID := '_SRCNID_'
	let $roleAction := '_ROLEACTION_'
	let $userName := tokenize($userJID, "@")[1]
	let $resourceTitle := tokenize($userJID, "/")[2]
	let $userDoc := (
			for $user in #OBJ_User_OBJ#
			where $user/Username = $userName
			return $user
	)
	let $resourceDoc := (
			for $resource in #OBJ_AssetResource_OBJ#
			where $resource/Info/Title = $resourceTitle
			return $resource
	)
	
	(: MIYE removing sedna code :)
	(: let $srcResource := index-scan('IPVSi_nids_default',$srcNID,'EQ')/.. " :)
	let $srcResource := doc(local:getUri($srcNID))/*

	
	let $srcUserOwnerJID := data($srcResource//OwnerUserJID)
	let $srcuserDoc :=  if ($srcUserOwnerJID  != '')  then
	                        let $srcUserName := tokenize($srcUserOwnerJID, "@")[1]
							let $userDoc := for $user in collection('ipvs.default.userlist')/*
												where $user/Username = $srcUserName
										    return $user
				            return  $userDoc
						 else 
						    ''	
    let $sourceDoc := if ($srcNID != '') then 
	                     <Source>
							<User> {$srcuserDoc} </User>
							<Resource> {$srcResource} </Resource>
 						 </Source>
					   else ''
	return
		<RequestData>
			<RoleAction>{$roleAction}</RoleAction>
			<Operator> 
		      <User> {$userDoc} </User>
		      <Resource>{$resourceDoc} </Resource>
		    </Operator>
			{$sourceDoc}
		</RequestData>	
 };
(: ------------------- End GetDestinationLib.xml -------------------- :)


let $requestDoc := local:createRequestDoc()
return $requestDoc