declare function local:getGroupInfo($groupId,$clipId) 
as element()*{
let $mediagroupdoc := for $b  in collection('/db/ipvs.default.mediastreamfileresourcelist')/*[(.//MediaStoreFileInfo/Type = 'MediaGroup') and (.//MediaGroupID = $groupId )]
                               return $b
let $bookmarklist := for $b in  collection('/db/ipvs.default.bookmarklist')/*[.//MediaStreamFileResourceNID = $mediagroupdoc/@NID]
return $b
let $groupinfo := if (($mediagroupdoc//MediaGroupID = $groupId) and ($mediagroupdoc//MediaGroupID/@ClipID = $clipId)) then 
                      <GroupInfo title='{data($mediagroupdoc/Info/Title)}' UUID='{data($mediagroupdoc//UUID)}' NID='{ data($mediagroupdoc/@NID) }' state='{ data($mediagroupdoc//StateFlag) }'>
					  	{$mediagroupdoc//MediaStoreFileInfo/MetaData}
						<BookmarkList>{$bookmarklist}</BookmarkList>
				     </GroupInfo>

				 else  <GroupInfo/>
return $groupinfo
};


declare function local:getFileWithBookmarkList( $ele as element()*)
as element ()* {
let $fileNID := data($ele/@NID)
let $groupId := data($ele//MediaGroupID)
let $clipId := data($ele//MediaGroupID/@ClipID)
let $bookmarklist := for $b in  collection('/db/ipvs.default.bookmarklist')/*[.//MediaStreamFileResourceNID = $fileNID]    
     return $b
let $groupinfo := if($groupId != '') then  
	let $b := local:getGroupInfo($groupId,$clipId)
     return $b
	 else <GroupInfo/>	      

return <File NID='{ data($ele/@NID) }' byID='{data($ele//UUID)}' type='{data($ele//MediaStoreFileInfo/Type)}' title='{data($ele/Info/Title)}'>
 {$ele//MediaStoreFileInfo/MetaData}{$ele//MediaStreamProfileInfo}
 <BookmarkList>{$bookmarklist}</BookmarkList>{$groupinfo}
 </File>

};

let $fileNID := '_FILENID_' 

let $fileEl := for $fileEl in collection('ipvs.default.mediastreamfileresourcelist')/*
						   						      [(.//@NID = $fileNID)]
								          	return $fileEl
								          	

let $item := local:getFileWithBookmarkList($fileEl)


return $item