declare function local:getUserInfo( $b as element()*, $detail as xs:string)
as element ()*
{
   	let $username := data($b//Username)
   	let $assetResource := for $a in  collection('/db/ipvs.default.assetresourcelist')/*[(@parentNID='default.assetresourcelist') 
	                                 and (substring-before(.//OwnerUserJID, "@localhost")= $username)] 
						  return $a
	
	let $presence := 
		if ($assetResource != '') then 
			$assetResource[1]/Contact/Presence
		else 
			'unavailable'

   	let $state := 
		if ($assetResource != '') then 
			$assetResource[1]//State/StateFlag
		else 
			'Offline'

   let $userInfo := 
		   		 <User NID='{ data($b/@NID) }'		   		 		 
		   		 		 username = '{ data($b//Username) }'		   		 		 
		   		 		 email = '{ data($b//Email) }'		   		 		 
		   		 		 fullName = '{ data($b//Name) }'
		   		 		 password = '{ data($b//Password) }'
		   		 		 creationDate = '{ data($b//CreationDate) }'
		   		 		 modifiedDate = '{ data($b//ModifiedDate) }'		   		 		 
		   		 		 externalAuthentication = '{ data($b//ExternalAuthentication) }'
						 presence = '{ $presence }'
						 state = '{ $state }'
		 		  	>     				 		  		 		  		  								
					{$b//Groups}
					{ if ($detail = 'EXTENDED') then 
						$b//UserPrivateData
					  else ''
					}
				</User> 
	return $userInfo
};


declare function local:getList()
as element()*
{
	let $list1 := 
		for $b in #OBJ_User_OBJ#
			where $b _XPATHAND_ 
			order by upper-case ($b_SORTBY_) _SORTORDER_       
			return $b
	return $list1
};

declare function local:formatItem($b as element()*, $detail as xs:string) {
	let $item := local:getUserInfo($b, $detail)
	return $item
};

declare function local:formatList($b as element()*, $detail as xs:string) {
	let $list:= $b
		return $b
};
