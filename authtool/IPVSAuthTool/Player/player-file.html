<html>
<head>
<title>IPVS Media Player</title>
<link href="pc.css" rel=stylesheet type=text/css>
<link href="style.css" rel=stylesheet type=text/css>
<script language="javascript" type="text/javascript">

var STATE_STOPPED = 0
var STATE_PAUSED  = 1
var STATE_PLAYING = 2
var g_bNatiVeSizeReSizeMode = false;
var g_frmLOGODISPLAY = true;
var g_streamState = false;
var g_mediaplayersettings = false;
var winWidth = 640;
var winHeight = 580;
var winTogHeight = 675;
var entrycount = 0;
var playerSet = {
         playerV2d: "ipvsplayer",
         playerMPEG2: "vlc",
         playerMPEG4: "vlc"
};
/*functions supporting v2d*/

function v2d_playStream() {    
 	v2d_RestoreSize(1);
 	document.getElementById('divaratio').style.display = "none";
	document.getElementById('divFPS').style.display = "block";
    v2d_Play();  
}

// regular screen mode
function v2d_RestoreSize(frm) {
    if ( g_bNatiVeSizeReSizeMode )
        return;
	offset = 110;
	if(frm == 0)
	{
        offset = 120;
	}
	
    w1 = document.body.clientWidth*0.96;
	minWidth = 450;
	minheight = 450*3/4;
    if((w1 < minWidth) || (document.body.clientHeight < minheight))
	{
	    offset = 15;
	    if(g_frmLOGODISPLAY)
		{
		    document.getElementById("frmlogo").style.display = "none";
		    document.getElementById("bottomControls").style.display = "none";
	    }
	}
	else
	{
	    if(g_frmLOGODISPLAY)
	    {
	        document.getElementById("frmlogo").style.display = "block";
		    document.getElementById("bottomControls").style.display = "block";
		}
    }
    h1 = w1*3/4;
    h2 = document.body.clientHeight - offset;
    w2 = h2*4/3	;
    width = 0;
    height = 0;
    if ( w1 < w2 ) {
        width = w1;
        height = h1;
    }
    else {
        width = w2;
        height = h2;
    }

	if(width < 90) {
	    return;
	}
    elem = document.getElementById( "IPVideoPlayer" );
    if ( elem == null || elem == undefined )
        return;

    elem.style.width  = width; 
    elem.style.height = height;
}

function v2d_Play() {    
    // if playing, ignore the command
    if ( IPVideoPlayer.PlayState == STATE_PLAYING )
      return;
    var port       = document.clientui.port.value;  
    var strServer  = document.clientui.ip.value;
    var protocol   = document.clientui.protocol.value;
    var fps        = parseInt(document.getElementById("fps").value);
    var bitrate    = 5120; 
    var latency    = document.getElementById("latency").value;
  
    if(!IsNumeric(bitrate))
    {
        displayError( "Please enter valid value for Bandwidth" );
        return;
    }
    
    sReduction = 1;
    strServer = strServer.replace(/^\s*|\s*$/g,"");
    url = "v2dfile://" + strServer;   
    Sport = port;
	IPVideoPlayer.Filename = url;
    IPVideoPlayer.ServerPort = Sport;
    IPVideoPlayer.MaxBandwidth = parseInt(bitrate);
    IPVideoPlayer.AVMode = 3;
    IPVideoPlayer.Fps = fps;
    IPVideoPlayer.SliceReduction = sReduction;
    IPVideoPlayer.Latency = latency;    

    document.clientui.url.value = url;
    curState = IPVideoPlayer.PlayState;    
    if(curState == STATE_PAUSED)
    {
        IPVideoPlayer.Resume();
        UpdateState();
    }
    else
    {
        IPVideoPlayer.Play();
        UpdateState();
    }
    
    //  If player is stopped and we call v2d_Mute() it will crash
    curState = IPVideoPlayer.PlayState; 
    if(curState == STATE_STOPPED)
		return;
    
    v2d_Mute();   
    setTimeout("UpdateState()", 10 );
}

function v2d_Stop() {
    
    // default mode on Play is Scale-to-fit
    g_bNatiVeSizeReSizeMode = false;
    // if stopped, ingore the command
    if ( IPVideoPlayer.PlayState == STATE_STOPPED )
        return;
    IPVideoPlayer.Stop();
	UpdateState();
}

function v2d_Repair() {
    v2d_Stop();
    // start playing after a second
    setTimeout('v2d_Play()', 1000 );
}

function v2d_Pause() {
   IPVideoPlayer.Pause();
	UpdateState();
}

function v2d_SkipFwd() {
    IPVideoPlayer.SkipFwd(30000);
	UpdateState();
}

function v2d_SkipBack() {

    IPVideoPlayer.SkipBack(10000);
	UpdateState();
}

function v2d_SetFps() {
    var fps = parseInt(document.getElementById("fps").value);
    IPVideoPlayer.Fps = fps;	
}

// hide or show components other than player
function ChangeDisplayMode() {
    ellogo = document.getElementById("frmlogo");
    elem = document.getElementById("divdetails");
    elemplayer = document.getElementById("IPVideoPlayer");

    if(elem.style.display == "block") {
 	    window.document.body.scroll = "no";
	    document.body.style.margin = 0;
	    elem.style.display = "none";
	    ellogo.style.display = "none";
	    g_frmLOGODISPLAY = false;
             
	    elemplayer.style.width = document.body.clientWidth;
	    elemplayer.style.height = document.body.clientHeight;
    }
    else {
  	    window.document.body.scroll = "no";
	    document.body.style.margin = 2; 
	    elem.style.display = "block";
        ellogo.style.display = "block";
        g_frmLOGODISPLAY = true;
        v2d_RestoreSize(1);
    }
    g_bNatiVeSizeReSizeMode = false;
    // set the resolution mode to scale-to-fit
    IPVideoPlayer.ScaleVideoToWindowSize();
    //ShowResolutionButtons();
}

// display player state
function UpdateState() {
    elem1 = document.getElementById( "IPVideoPlayer" );
    if ( elem1 == null || elem1 == undefined )
        return;

    curState = IPVideoPlayer.PlayState;
    elem = document.getElementById("state");
    if ( elem ) {
        if ( curState == STATE_PLAYING ) {
            elem.innerText = "Playing"; 
            setTimeout("UpdateState()", 15000 );
        }
        else if ( curState == STATE_PAUSED ) {
            elem.innerText = "Paused"; 
            setTimeout("UpdateState()", 30000 );
        }
        else {
        elem.innerText = "Stopped"; 
        }
    }
    elemHolder = document.getElementById("error_display");  
    if ( IPVideoPlayer.ErrorMessage.length > 0 ) {
        elemHolder.innerText =    "Error: " + IPVideoPlayer.ErrorMessage + " Code: " + IPVideoPlayer.ErrorCode;
        elemHolder.style.visibility = "visible";
        v2d_Stop();
    }
    else
        elemHolder.style.visibility = "hidden"; 
}

function displayError( strError ) {
    elem = document.getElementById("error_display");  
    if ( strError.length == 0 ) {
        elem.innerText = "";
        elem.style.visibility = "hidden";
    }
    else {  
        elem.innerText = "Validation error: " + strError;
        elem.style.visibility = "visible";
    }
}

function v2d_FullScreen() {
   	elem = document.getElementById( "IPVideoPlayer" );
    if( elem != null && elem != undefined ) {
        IPVideoPlayer.ToggleDisplay();
       }
}

function v2d_ScaleToWindow() {
    g_bNatiVeSizeReSizeMode = false;
    elem = document.getElementById( "IPVideoPlayer" );
	if( elem != null && elem != undefined )
	{
	if(g_mediaplayersettings!=true){
	window.resizeTo(winWidth, winHeight);
	}
	else{
	window.resizeTo(winWidth, winHeight);
	if(entrycount==0)
	window.resizeBy(-10,-20);
	entrycount++;
	}
	    if(g_mediaplayersettings == false)
        window.document.body.scroll = "no";
        else
        window.document.body.scroll = "yes";
        document.body.style.margin = 0;
        v2d_RestoreSize(1);
        // only if state is Playing
        if ( IPVideoPlayer.PlayState == STATE_PLAYING )
        IPVideoPlayer.ScaleVideoToWindowSize();
	}
}

function v2d_DisplayNativeSizeWithResize() {
    elem = document.getElementById( "IPVideoPlayer" );
	
    if ( elem == null || elem == undefined )
        return;
    var agt = navigator.appMinorVersion.toLowerCase();
    winWidth = document.body.scrollWidth + 12;
    if(agt.indexOf("sp2") != -1)  //checking IE Servicepack
    {
	     winHeight = document.body.scrollHeight + 60;
    }
    else
    {
	       winHeight = document.body.scrollHeight + 66;
    }
    var width = IPVideoPlayer.GetNativeWidth();
    var height = IPVideoPlayer.GetNativeHeight();
	if((width<=0)&&(height<=0)||(width=='')&&(height=='')){
	    return; 
	}
	else{
        g_bNatiVeSizeReSizeMode = true;   
        elem.style.width  = width; 
        elem.style.height = height;
        IPVideoPlayer.ShowNativeVideoResolution();
		tmpWinWidth = width + 50;
		tmpWinHeight = height + 200;
		if(tmpWinWidth > screen.availWidth)
		{
		    tmpWinWidth = screen.availWidth;
		}
		if(tmpWinHeight > screen.availHeight)
		{
		    tmpWinHeight = screen.availHeight;
		}
		window.resizeTo(tmpWinWidth, tmpWinHeight);
	}
	window.document.body.scroll = "yes";
	document.body.style.margin = 0;
	
}

function v2d_Mute() {
   IPVideoPlayer.Mute = (document.getElementById("mute").checked) ? 1 : 0;
}

</script>

<script language="javascript">

function getSupportedStreamTypes() {
    return "MPEGTS,RTP,V2D";
}

function setControlUI(attrName, attrValue) {
    document.getElementById(attrName).value = attrValue;
}

function playStream(streamType, protocol, ip, port) {
   streamType = getPlayerObject();
   document.clientui.StreamType.value=streamType;
   cmnSwitchFnc('playStream();',1);
        document.getElementById("btnCol").style.display = "none";
        document.getElementById("btnCh").style.display = "block";
	    document.getElementById("btnPause").style.display = "block";
        document.getElementById("btnResume").style.display = "none";  
        document.getElementById("btnPVR").style.display = "none";
   
}

function pauseStream() {
        document.getElementById("btnCol").style.display = "none";
        document.getElementById("btnCh").style.display = "block";
        document.getElementById("btnPause").style.display = "none";
        document.getElementById("btnResume").style.display = "block";
        document.getElementById("btnPVR").style.display = "none";
     
    playerType = getPlayerObject();
    cmnSwitchFnc('Pause();',playerType);
}

function stopStream() {
    g_streamState = true;
    stopPlayer();
	self.close();
}

function skipFwd() {
    
    playerType = getPlayerObject();
    cmnSwitchFnc('SkipFwd();',playerType);	
}

function skipBack() {
    
    playerType = getPlayerObject();
    cmnSwitchFnc('SkipBack();',playerType);
	
}

function stopPlayer() {    
        playerType = getPlayerObject();
        cmnSwitchFnc('Stop();',playerType);
        
       // delete playerOBJ;
        window.close();
        return true;
}

function scriptPause( iMilliseconds )
{
    while(!g_streamState)
    {
        var sDialogScript = 'window.setTimeout( function () { window.close(); }, ' + iMilliseconds + ');';
        window.showModalDialog('javascript:document.writeln ("<script>' + sDialogScript + '<' + '/script>")');
    }
}


function RestoreSize() {
   if(g_mediaplayersettings == true){
    document.getElementById("trsettings").style.display = "block";
    //window.document.body.scroll = "yes";
   }
   else{
    document.getElementById("trsettings").style.display = "none";
    // window.document.body.scroll = "no";
   }
	playerType = getPlayerObject();
    cmnSwitchFnc('RestoreSize(0);',playerType);
}

function Repair(){
	playerType = getPlayerObject();
	cmnSwitchFnc('Repair();',playerType);
}

function getPlayerObject() {
	VLCplayer = document.getElementById("vlc");
	V2Dplayer = document.getElementById("IPVideoPlayer");
	quicktimeplayer = document.getElementById("quicktime");
	elecardplayer = document.getElementById("elecard");
	if(V2Dplayer != null && V2Dplayer != undefined)	{
        return 1;
	}
	else if(VLCplayer != null && VLCplayer != undefined) {
	    return 2;
	}
	if(quicktimeplayer != null && quicktimeplayer != undefined)	{
	    return 4;
	}
	else if(elecardplayer != null && elecardplayer != undefined) {
	    return 2;
	}
	else {
	    return 0;
	}
}

// resolution mode - scale-to-fit window
function ScaleToWindow() {
    playerType = getPlayerObject();
    cmnSwitchFnc('ScaleToWindow();',playerType);
	
	document.getElementById("btnNative").style.display = "block";
	document.getElementById("btnScale").style.display = "none";
	window.document.body.scroll = "no";
}

function FullScreen() {
    playerType = getPlayerObject();
    cmnSwitchFnc('FullScreen();',playerType);
}

// resolution mode - native size and also resize the player dimensions
function DisplayNativeSizeWithResize() {
    window.moveTo(0,0);
	document.body.style.margin = 0;
    playerType = getPlayerObject();
    cmnSwitchFnc('DisplayNativeSizeWithResize();',playerType);
	document.getElementById("btnNative").style.display = "none";
	document.getElementById("btnScale").style.display = "block";
	window.document.body.scroll = "yes";
}

function mute() {
    playerType = getPlayerObject();
    cmnSwitchFnc('Mute();',playerType);
}
function SetFps() {    
    playerType = getPlayerObject();
    cmnSwitchFnc('SetFps();',playerType);
}

function toggleSettings(mode){
    document.getElementById("trsettings").style.display = mode;
    if(g_bNatiVeSizeReSizeMode == true)
        return;
	if(mode == "block")
	{
		if(g_mediaplayersettings!=true)
		window.resizeBy(0, 49);
		g_mediaplayersettings=true;
  	}
	else
	{
		g_mediaplayersettings=false;
		window.resizeBy(0, -49)
 	 }
}

    
//  check for valid numeric strings	
function IsNumeric( strString )
{
    // only numbers
    var strValidChars = "0123456789";
    var strChar;
    var blnResult = true;

    if (strString.length == 0) return false;

    //  test strString consists of valid characters listed above
    for (i = 0; i < strString.length && blnResult == true; i++)
    {
        strChar = strString.charAt(i);
        if (strValidChars.indexOf(strChar) == -1)
        {
            blnResult = false;
        }
    }
  
    return blnResult;
}

function initPlayersSet(){    
   
}

function cmnSwitchFnc(fncName,fncType){
    var fncval;
	if(fncName!=''){
		
	    if(fncType==1){
		    if((playerSet['playerV2d']!="")&&(playerSet['playerV2d']=="ipvsplayer")){
			    fncval=  eval('v2d_'+fncName);
		    }
	    }
	  
    }
}

function getAbsolutePathName()
{
    // URL sends spaces as %20 and depending on IE version some \ as /
    var q = window.location.search;    

    var relMediaPath = q.substring(q.indexOf("v2dfile:")+8, q.length);
    relMediaPath = relMediaPath.replace(/\//g,"\\\\"); /*// replace / with \\*/

    q = window.location.pathname;   
    var absPlayerPath = q.substring(q.indexOf("/")+1, q.length); // strip the first /    
    
    // ignore file extension so that we can keep changing it
    // Handle IE 6 - IE 7 issues
    var playerRootDir = "";
    var idx = absPlayerPath.indexOf("Player/player-file."); // IE7
    if(idx == -1)
    {
        idx = absPlayerPath.indexOf("Player\\player-file."); // IE6
        playerRootDir = absPlayerPath.substring(0, idx);            
        playerRootDir = playerRootDir.replace(/\\/g,"\\\\"); /*// replace \ with \\    */        
    }
    else
    {
        playerRootDir = absPlayerPath.substring(0, idx);            
        playerRootDir = playerRootDir.replace(/\//g,"\\\\"); /* // replace / with \\  */        
    }   
         
    var absMediaPath = playerRootDir + relMediaPath;     
    absMediaPath = absMediaPath.replace(/%20/g," ");
    absMediaPath = absMediaPath.replace(/%26/g,"&");
     return absMediaPath;
 }

function init() {
    document.clientui.port.value = 6060;  
    document.clientui.ip.value = getAbsolutePathName();
    document.clientui.protocol.value;
    document.getElementById("fps").value = 5;
    document.getElementById("latency").value = 500;

    
    playStream(1, document.clientui.protocol.value, document.clientui.ip.value, document.clientui.port.value);
}

</script>
</head>
<body bgcolor="#000033" style="margin: 2px;" onresize="RestoreSize();" onunload="stopPlayer();">
<table id="ipvsPlayer" cellpadding="0" cellspacing="0" border=0 align="center">
	<tr id="frmlogo">
	<td>
		<table width="100%" background="images/headerBG.jpg"  style="border: 1px solid gray;" >
			<tr>
			<td width="22%" align="left">
	    		<table>
					<tr>
					<td><img src="images/logoClientHeader.gif" align="middle">&nbsp;&nbsp;&nbsp;<span class="title">Media&nbsp;Player</span></td>
					</tr>
				</table>
			</td>
			<td width="43%" class="labelcellhd">
			</td>
			<td width="35%" align="right" valign="middle">
			    <table width="100%">
			        <tr>
			        <td align=right>
                        <div id='btnCol' style='display:none'><A href="javascript:doAction('COLLABORATE', '', '');"><img src="images/playerBtnGroup.gif" alt="Collaborate" width="21" height="21" border="0"></A></div>
                        <div id='btnCh' style='display:none'><A href="javascript:doAction('CHANNEL', '', '');"><img src="images/playerBtnUngroup.gif" alt="SwitchToChannel" width="21" height="21" border="0"></A></div>
                    </td>
			        <td>&nbsp;&nbsp;</td>
			        <td align=right>
				        <table cellspacing="0" cellpadding="0">
			    	        <tr>
				            <td id="btnScale" style="display:none">
					            <img id="btnScale" src="images/btnScale.gif" onclick="ScaleToWindow()" style="cursor: pointer;" alt="Scale Player Size">
					        </td>
					        <td id="btnNative">&nbsp;<img id="btnNative" src="images/btnNativeSize.gif" onclick="DisplayNativeSizeWithResize()" style="cursor: pointer;" alt="Native Size">
					        </td>
					        <td>&nbsp;<img src="images/btnFullScreen.gif"onclick="FullScreen()" style="cursor: pointer;" alt="Full Screen Size">
					        </td>
					        <td>&nbsp;<img src="images/btnWindowClose.gif" onclick="stopPlayer()" style="cursor: pointer;" alt="Stop" border="0"></A>
					        </td>
					        </tr>
				        </table>
			        </td>
			        </tr>
		        </table>
	        </td>
	        </tr>
        </table>
	</td>
    </tr>
    <tr>
	<td class="screen" align="center"><div id='playerOBJ' ><OBJECT id="IPVideoPlayer" codeBase=IPVPlayerCtrl.cab#Version=2,3,3,4 classid=CLSID:A2A6189E-44F4-4D69-9CE4-8329312D2E3A VIEWASTEXT><PARAM NAME="BackColor" VALUE="7874560"><PARAM NAME="BorderColor" VALUE="0"><PARAM NAME="AutoSize" VALUE="0"><PARAM NAME="AutoStart" VALUE="0"><PARAM NAME="SessionId" VALUE="0"></OBJECT></div></td>
	</tr>
	<tr id="bottomControls">
  	    <td class="playerControls">
  		    <div id="divdetails" style="display:block;margin:0">
			<div id="statusDisplayContainer">
			<div id="statusDisplay">
			    <span id="state" style="visibility:visible" noWrap><label for="name">Status: Idle</label></span>
				<span id="error_display" style="visibility:hidden;color: red" nowrap>-error status-</span>
			</div>
			<div id="clientURL">
				<FORM name="clientui">
				<input type="hidden" class="clientURL" name="url" readonly="true" size=30><br>
				<input type="hidden" name='StreamType' value=''>
				<input type="hidden" name='protocol' value=''>
				<input type="hidden" name='ip' value=''>
				<input type="hidden" name='port' value=''>
				</FORM>
			</div>
			</div>
			<table id="restStuff" width="100%" border="0">
			    <tr>
			  	<td>
				    <table border="0" width="100%" cellpadding="0" cellspacing="0">	
			     	    <tr>
						<td align="left" width="192">
						    <table cellspacing="0" cellpadding="0" border="0">
						<tr>
                        <td id="btnPVR" style='display:none'>
							<A href="javascript:doAction('PAUSE', '', '');"><img id="btnPVR" src="images/playerBtnSmallPVR.gif" alt="PVRControls" width="32" height="32" border="0"></A>&nbsp;
						</td>
						<td id="btnPause">
						    <A href="javascript:pauseStream();"><img id="btnPause" src="images/playerBtnPause.gif" alt="Pause" width="32" height="32" border="0"></A>&nbsp;
						</td>
						<td id="btnResume" style="display:none">
						    <A href="javascript:playStream();"><img src="images/playerBtnPlay.gif" alt="Resume" width="32" height="32" border="0"></A>&nbsp;
						</td>						
                        <td id="btnSkpBack">
						    <A href="javascript:skipBack();"><img src="images/playerBtnSkipBack.gif" alt="SkipBack" width="32" height="32" border="0"></A>&nbsp;
						</td>
                        <td id="btnSkpFwd">
						    <A href="javascript:skipFwd();"><img src="images/playerBtnSkipForward.gif" alt="SkipFwd" width="32" height="32" border="0"></A>&nbsp;
						</td>
						</tr>
					</table>
				</td>
			  <td align="right">&nbsp;<a href="#"><img src="images/playerBtnSettings.gif" alt="Display Media Player Settings" width="21" height="21" border="0" align="absmiddle" onclick="toggleSettings('block')";></a></td>
       		 	</tr>
          	</table>
        </td>
        </tr>
		<tr id="trsettings" style="display:none">
		<td>
		    <table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#CEDCE9" style="border:solid 2px #cedce9">
			    <tr>
				<td class="header4" width="33%"><b>Settings</b></td>
				<td class="header4"  width="33%"> </td>
				<td  align="right" width="33%" class="header4"><a href="#"><img src="images/btnUpArrow.gif" alt="Hide Media Player Settings" border="0" onclick="toggleSettings('none')";></a></td>
				</tr>
				<tr>
				<td class="T2" width="33%">
					<div id="divaratio" style="display:none;margin:0">Aspect&nbsp;Ratio:&nbsp;<select id="aspect" class="textBoxBasic" onchange="vlc_Repair()"><option value="4:3">4:3</option><option value="16:9">16:9</option></select></div>
					<div id="divFPS" style="display:block;margin:0" valign="Top">FPS:&nbsp;<select id="fps" class="textBoxBasic" onchange="SetFps()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option><option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option><option value="40">40</option><option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option><option value="46">46</option><option value="47">47</option><option value="48">48</option><option value="49">49</option><option value="50">50</option><option value="51">51</option><option value="52">52</option><option value="53">53</option><option value="54">54</option><option value="55">55</option><option value="56">56</option><option value="57">57</option><option value="58">58</option><option value="59">59</option><option value="60">60</option></select>&nbsp;&nbsp;&nbsp;</div>
					
				</td>
                <td  width="33%" align="center">Latency:<input size=2 id="latency" value="500" name=latency onchange="v2d_Repair()">
                </td>                				
				<td  width="33%" align="right">Mute:<input type="checkbox" id="mute" onclick="mute()">
				</td>
				</tr>                                
			</table>
		</td>
		</tr>
		    </table> 
		    </div> 
		</td>
	</tr>
</table>
<SCRIPT>    
 init();    
</SCRIPT>
</BODY>
</html>
